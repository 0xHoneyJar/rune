name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # =============================================================================
  # TEMPLATE PROTECTION - Blocks forbidden files from being committed
  # =============================================================================
  template-guard:
    name: Template Protection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Block forbidden template files
        id: check-forbidden
        run: |
          echo "Checking for forbidden template files..."

          # Define forbidden patterns for the Sigil template repository
          # These files should NEVER be committed to the main Sigil template
          FORBIDDEN_FILES=(
            "sigil-mark/moodboard.md"
            "sigil-mark/rules.md"
            "sigil-mark/inventory.md"
          )

          VIOLATIONS=()

          # Check for forbidden files (excluding README.md placeholders)
          for pattern in "${FORBIDDEN_FILES[@]}"; do
            if [ -f "$pattern" ]; then
              VIOLATIONS+=("$pattern")
            fi
          done

          if [ ${#VIOLATIONS[@]} -gt 0 ]; then
            echo ""
            echo "============================================================"
            echo "ERROR: Forbidden files detected in template repository!"
            echo "============================================================"
            echo ""
            echo "The following files must NOT be committed to the Sigil template:"
            echo ""
            for file in "${VIOLATIONS[@]}"; do
              echo "  - $file"
            done
            echo ""
            echo "These files are project-specific and should be gitignored."
            echo "If this is intentional, add [skip-template-guard] to commit message."
            echo "============================================================"
            exit 1
          fi

          echo "Template protection check passed - no forbidden files found"

      - name: Check for skip override
        if: failure() && contains(github.event.head_commit.message, '[skip-template-guard]')
        run: |
          echo "WARNING: Template guard bypassed via [skip-template-guard] in commit message"
          echo "This should only be used for exceptional circumstances!"

  validate:
    name: Validate Framework Files
    needs: template-guard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          for file in $(find . -name "*.json" -not -path "./node_modules/*" -not -path "./.git/*"); do
            echo "Checking $file"
            python3 -m json.tool "$file" > /dev/null || { echo "Invalid JSON: $file"; exit 1; }
          done
          echo "All JSON files are valid"

      - name: Check Sigil skill definitions exist
        run: |
          echo "Checking required Sigil skill definitions..."
          SKILLS=(
            ".claude/skills/sigil-setup/SKILL.md"
            ".claude/skills/sigil-envisioning/SKILL.md"
            ".claude/skills/sigil-codifying/SKILL.md"
            ".claude/skills/sigil-crafting/SKILL.md"
            ".claude/skills/sigil-approving/SKILL.md"
            ".claude/skills/sigil-inheriting/SKILL.md"
            ".claude/skills/sigil-updating/SKILL.md"
          )
          MISSING=0
          for skill in "${SKILLS[@]}"; do
            if [ ! -f "$skill" ]; then
              echo "Missing Sigil skill: $skill"
              MISSING=$((MISSING + 1))
            fi
          done
          if [ $MISSING -gt 0 ]; then
            echo "Warning: $MISSING Sigil skill(s) missing - this may be expected during development"
          else
            echo "All Sigil skills present"
          fi

      - name: Check Sigil command definitions exist
        run: |
          echo "Checking required Sigil command definitions..."
          COMMANDS=(
            ".claude/commands/setup.md"
            ".claude/commands/envision.md"
            ".claude/commands/codify.md"
            ".claude/commands/craft.md"
            ".claude/commands/approve.md"
            ".claude/commands/inherit.md"
            ".claude/commands/update.md"
          )
          MISSING=0
          for cmd in "${COMMANDS[@]}"; do
            if [ ! -f "$cmd" ]; then
              echo "Missing Sigil command: $cmd"
              MISSING=$((MISSING + 1))
            fi
          done
          if [ $MISSING -gt 0 ]; then
            echo "Warning: $MISSING Sigil command(s) missing - this may be expected during development"
          else
            echo "All Sigil commands present"
          fi

      - name: Check documentation exists
        run: |
          echo "Checking required documentation..."
          DOCS=(
            "README.md"
            "CLAUDE.md"
            "PROCESS.md"
            "CONTRIBUTING.md"
            "CHANGELOG.md"
            "LICENSE.md"
            "INSTALLATION.md"
          )
          for doc in "${DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "Missing required documentation: $doc"
              exit 1
            fi
          done
          echo "All required documentation present"

      - name: Validate version consistency
        run: |
          echo "Checking version consistency..."

          # Get version from CHANGELOG
          CHANGELOG_VERSION=$(grep -oP '## \[\K[0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | head -1)
          echo "CHANGELOG version: $CHANGELOG_VERSION"

          # Get version from .sigil-version.json
          if [ -f ".sigil-version.json" ]; then
            VERSION_JSON=$(python3 -c "import json; print(json.load(open('.sigil-version.json'))['framework_version'])")
            echo ".sigil-version.json version: $VERSION_JSON"

            if [ "$CHANGELOG_VERSION" != "$VERSION_JSON" ]; then
              echo "Version mismatch: CHANGELOG=$CHANGELOG_VERSION, .sigil-version.json=$VERSION_JSON"
              exit 1
            fi
          fi

          echo "Version consistency check passed"

      - name: Check for broken internal links
        run: |
          echo "Checking for broken internal links in documentation..."

          for mdfile in README.md CLAUDE.md PROCESS.md CONTRIBUTING.md INSTALLATION.md; do
            if [ -f "$mdfile" ]; then
              # Extract markdown links like [text](file.md)
              grep -oP '\[.*?\]\(\K[^)]+(?=\))' "$mdfile" 2>/dev/null | while read link; do
                # Skip external URLs and anchors
                if [[ "$link" == http* ]] || [[ "$link" == "#"* ]]; then
                  continue
                fi

                # Check if file exists
                if [ ! -f "$link" ] && [ ! -d "$link" ]; then
                  echo "Broken link in $mdfile: $link"
                fi
              done
            fi
          done

          echo "Internal link check completed"

  markdown-lint:
    name: Lint Markdown
    needs: template-guard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Create markdownlint config
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD024": { "siblings_only": true }
          }
          EOF

      - name: Lint Markdown files
        run: markdownlint '**/*.md' --ignore node_modules --ignore sigil-mark || true
        # Note: Using || true to not fail on lint warnings for now

  yaml-lint:
    name: Lint YAML
    needs: template-guard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: yamllint .github/ || true
        # Note: Using || true to not fail on lint warnings for now
