#!/usr/bin/env bash
# sigilup - Sigil toolchain installer
#
# Usage:
#   sigilup                    Install latest stable version
#   sigilup --version 1.0.0    Install specific version
#   sigilup --nightly          Install latest nightly build
#   sigilup --help             Show help

set -eo pipefail

SIGILUP_DIR="${SIGILUP_DIR:-$HOME/.sigil}"
SIGILUP_BIN_DIR="$SIGILUP_DIR/bin"
REPO="0xHoneyJar/sigil"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info()  { echo -e "${GREEN}[INFO]${NC} $1"; }
warn()  { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

usage() {
    cat << EOF
sigilup - Sigil toolchain installer

USAGE:
    sigilup [OPTIONS]

OPTIONS:
    -v, --version <VERSION>    Install a specific version (e.g., 1.0.0)
    -n, --nightly              Install the latest nightly build
    -h, --help                 Show this help message

EXAMPLES:
    sigilup                    # Install latest stable
    sigilup -v 1.0.0           # Install version 1.0.0
    sigilup --nightly          # Install nightly

COMPONENTS:
    anchor    Physics validation CLI
    lens      Component inspection CLI

EOF
}

detect_platform() {
    local os arch

    os=$(uname -s)
    arch=$(uname -m)

    case "$os" in
        Darwin)
            case "$arch" in
                arm64)  echo "aarch64-apple-darwin" ;;
                x86_64) echo "x86_64-apple-darwin" ;;
                *)      error "Unsupported architecture: $arch"; exit 1 ;;
            esac
            ;;
        Linux)
            case "$arch" in
                x86_64|amd64) echo "x86_64-unknown-linux-gnu" ;;
                aarch64|arm64) echo "aarch64-unknown-linux-gnu" ;;
                *)      error "Unsupported architecture: $arch"; exit 1 ;;
            esac
            ;;
        *)
            error "Unsupported OS: $os"
            exit 1
            ;;
    esac
}

get_latest_version() {
    local version
    version=$(curl -fsSL "https://api.github.com/repos/$REPO/releases" 2>/dev/null \
        | grep -o '"tag_name": "cli-v[^"]*"' \
        | head -1 \
        | sed 's/"tag_name": "cli-v\(.*\)"/\1/')

    if [[ -z "$version" ]]; then
        error "Failed to fetch latest version"
        exit 1
    fi

    echo "$version"
}

download_binary() {
    local name=$1
    local version=$2
    local platform=$3
    local temp_dir=$4

    local archive="${name}-${version}-${platform}.tar.gz"
    local url="https://github.com/$REPO/releases/download/cli-v${version}/${archive}"

    info "Downloading ${name} v${version}..."

    if ! curl -fsSL -o "$temp_dir/$archive" "$url"; then
        error "Failed to download $name"
        error "URL: $url"
        return 1
    fi

    # Extract
    tar -xzf "$temp_dir/$archive" -C "$temp_dir"

    # Install
    if [[ -f "$temp_dir/$name" ]]; then
        mv "$temp_dir/$name" "$SIGILUP_BIN_DIR/$name"
        chmod +x "$SIGILUP_BIN_DIR/$name"
        info "Installed ${name} to $SIGILUP_BIN_DIR/${name}"
    else
        error "Binary $name not found in archive"
        return 1
    fi
}

main() {
    local version=""
    local nightly=false

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -v|--version)
                version="$2"
                shift 2
                ;;
            -n|--nightly)
                nightly=true
                shift
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            *)
                error "Unknown option: $1"
                usage
                exit 1
                ;;
        esac
    done

    echo ""
    echo -e "${BLUE}sigilup${NC} - Sigil toolchain installer"
    echo ""

    # Create bin directory
    mkdir -p "$SIGILUP_BIN_DIR"

    # Detect platform
    local platform
    platform=$(detect_platform)
    info "Detected platform: $platform"

    # Get version
    if [[ -z "$version" ]]; then
        if $nightly; then
            version="nightly"
            warn "Nightly builds not yet available, using latest stable"
        fi
        info "Fetching latest version..."
        version=$(get_latest_version)
    fi

    info "Installing Sigil CLIs v${version}"
    echo ""

    # Create temp directory
    local temp_dir
    temp_dir=$(mktemp -d)
    trap "rm -rf $temp_dir" EXIT

    # Download and install binaries
    local failed=false

    if ! download_binary "anchor" "$version" "$platform" "$temp_dir"; then
        failed=true
    fi

    if ! download_binary "lens" "$version" "$platform" "$temp_dir"; then
        failed=true
    fi

    echo ""

    if $failed; then
        error "Some components failed to install"
        echo ""
        echo "The CLI release may not exist yet. Check:"
        echo "  https://github.com/$REPO/releases"
        echo ""
        exit 1
    fi

    # Verify installation
    echo -e "${GREEN}Installation complete!${NC}"
    echo ""

    if [[ -f "$SIGILUP_BIN_DIR/anchor" ]]; then
        echo -e "  anchor: $("$SIGILUP_BIN_DIR/anchor" --version 2>/dev/null || echo "v$version")"
    fi

    if [[ -f "$SIGILUP_BIN_DIR/lens" ]]; then
        echo -e "  lens:   $("$SIGILUP_BIN_DIR/lens" --version 2>/dev/null || echo "v$version")"
    fi

    echo ""

    # PATH check
    if [[ ":$PATH:" != *":$SIGILUP_BIN_DIR:"* ]]; then
        warn "Add to your PATH:"
        echo ""
        echo "  export PATH=\"\$HOME/.sigil/bin:\$PATH\""
        echo ""
    fi
}

main "$@"
